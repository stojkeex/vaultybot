<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaulty - Connect Your World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#000000',
                        'secondary': '#1A1A1A',
                        'accent': '#2B2B2B',
                        'highlight': '#00fbff',
                        'highlight-hover': '#00ddeb',
                        'text-main': '#F9FAFB', // Off-white
                        'text-secondary': '#9CA3AF', // Light gray
                        'success': '#10B981',
                        'danger': '#EF4444',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; }
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1A1A1A; }
        ::-webkit-scrollbar-thumb { background: #2B2B2B; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00fbff; }
        .nav-btn.active svg { color: #00fbff; transform: scale(1.1); }
        .nav-btn svg { transition: all 0.2s ease-in-out; }
        .btn-primary { 
            background: linear-gradient(90deg, rgba(0,251,255,1) 0%, rgba(0,42,250,1) 50%, rgba(255,0,212,1) 100%);
            color: #FFFFFF;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.4s ease;
            background-size: 200% auto;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover { 
            background-position: right center; /* change the direction of the change here */
            transform: scale(1.03);
        }
        .btn-primary:disabled {
            background: #2B2B2B;
            cursor: not-allowed;
            transform: scale(1);
        }
        .input-field {
            background-color: #2B2B2B;
            border: 1px solid #4B5563;
            color: #F9FAFB;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #00fbff;
            box-shadow: 0 0 0 3px rgba(0, 251, 255, 0.3);
        }
        .chat-bubble-sent {
            background-color: #2B2B2B;
            align-self: flex-end;
        }
        .chat-bubble-received {
            background-color: #1A1A1A;
            align-self: flex-start;
        }
        .people-tab {
            cursor: pointer;
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .people-tab.active {
            color: #00fbff;
            border-bottom-color: #00fbff;
        }
    </style>
</head>
<body class="bg-primary text-text-main">

    <!-- Global Loader -->
    <div id="loader" class="fixed inset-0 bg-primary z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-highlight"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                 <h1 class="text-5xl font-extrabold bg-clip-text text-transparent" style="background-image: linear-gradient(90deg, rgba(0,251,255,1) 0%, rgba(0,42,250,1) 50%, rgba(255,0,212,1) 100%);">Vaulty</h1>
                <p class="text-text-secondary mt-2">Connect Your World.</p>
            </div>
            <!-- Login Form -->
            <div id="login-view">
                <form id="login-form" class="bg-secondary shadow-2xl rounded-xl p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-text-main">Welcome Back</h2>
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-text-secondary mb-1">Email</label>
                        <input type="email" id="login-email" required class="input-field" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-text-secondary mb-1">Password</label>
                        <input type="password" id="login-password" required class="input-field" placeholder="••••••••">
                    </div>
                    <p id="login-error" class="text-danger text-sm text-center"></p>
                    <button type="submit" class="w-full btn-primary">Login</button>
                    <p class="text-center text-sm text-text-secondary">
                        Don't have an account? <a href="#" id="show-register" class="font-medium text-highlight hover:text-highlight-hover">Sign up</a>
                    </p>
                </form>
            </div>
            <!-- Register Form -->
            <div id="register-view" class="hidden">
                 <form id="register-form" class="bg-secondary shadow-2xl rounded-xl p-8 space-y-6">
                    <h2 class="text-2xl font-bold text-center text-text-main">Create Account</h2>
                    <div>
                        <label for="register-username" class="block text-sm font-medium text-text-secondary mb-1">Username</label>
                        <input type="text" id="register-username" required class="input-field" placeholder="your_username">
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-text-secondary mb-1">Email</label>
                        <input type="email" id="register-email" required class="input-field" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-text-secondary mb-1">Password</label>
                        <input type="password" id="register-password" required class="input-field" placeholder="min. 6 characters">
                    </div>
                    <p id="register-error" class="text-danger text-sm text-center"></p>
                    <button type="submit" class="w-full btn-primary">Create Account</button>
                    <p class="text-center text-sm text-text-secondary">
                        Already have an account? <a href="#" id="show-login" class="font-medium text-highlight hover:text-highlight-hover">Log in</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <main id="main-content" class="pb-24 pt-6 px-4">
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <div class="max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-text-main">Timeline</h1>
                        <button id="logout-btn" class="text-sm text-text-secondary hover:text-highlight transition-colors">Logout</button>
                    </div>
                    <!-- Create Post Card -->
                    <div class="bg-secondary p-4 rounded-xl mb-6 shadow-lg">
                        <textarea id="post-content" class="input-field w-full h-24 resize-none" placeholder="What's on your mind?"></textarea>
                        <div class="text-right mt-3">
                            <button id="create-post-btn" class="btn-primary">Post</button>
                        </div>
                    </div>
                    <!-- Posts Container -->
                    <div id="posts-container" class="space-y-6">
                        <!-- Posts will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Marketplace Page -->
            <div id="marketplace-page" class="page">
                 <div class="max-w-5xl mx-auto">
                    <h1 class="text-3xl font-bold text-text-main mb-6">Marketplace</h1>
                    <div class="bg-secondary p-4 rounded-xl mb-6 shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Sell an Item</h2>
                        <div class="space-y-4">
                            <input id="item-name" class="input-field" placeholder="Item Name">
                            <textarea id="item-description" class="input-field h-24 resize-none" placeholder="Description"></textarea>
                            <input type="number" id="item-price" class="input-field" placeholder="Price ($)">
                        </div>
                        <button id="add-item-btn" class="mt-4 w-full btn-primary">List Item</button>
                    </div>
                    <div id="marketplace-items-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Marketplace items will be added here -->
                    </div>
                 </div>
            </div>
            
            <!-- Groups Page -->
            <div id="groups-page" class="page">
                 <div class="max-w-3xl mx-auto">
                    <div id="groups-list-view">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-text-main">Groups</h1>
                            <button id="show-create-group-btn" class="btn-primary text-sm !py-2 !px-3">Create</button>
                        </div>
                        <div id="my-groups-container" class="space-y-3">
                            <!-- User's groups will be listed here -->
                        </div>
                    </div>
                    <div id="create-group-view" class="hidden">
                        <h1 class="text-3xl font-bold text-text-main mb-6">Create a New Group</h1>
                        <div class="bg-secondary p-4 rounded-xl space-y-4">
                            <input id="group-name" class="input-field" placeholder="Group Name">
                            <textarea id="group-description" class="input-field h-24" placeholder="Group Description"></textarea>
                            <div class="flex justify-end space-x-3">
                                <button id="cancel-create-group-btn" class="bg-accent hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                                <button id="create-group-btn" class="btn-primary">Create Group</button>
                            </div>
                        </div>
                    </div>
                    <div id="group-chat-view" class="hidden h-[calc(100vh-150px)] flex flex-col">
                        <div class="flex items-center mb-4 p-2 bg-secondary rounded-t-xl">
                            <button id="back-to-groups-btn" class="mr-4 text-highlight">&larr;</button>
                            <img id="group-chat-pic" src="" class="w-10 h-10 rounded-full mr-3">
                            <h2 id="group-chat-name" class="text-xl font-bold"></h2>
                        </div>
                        <div id="group-messages-container" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col">
                            <!-- Group messages here -->
                        </div>
                        <div class="p-4 bg-secondary rounded-b-xl flex">
                            <input type="text" id="group-message-input" class="input-field flex-grow rounded-r-none" placeholder="Type a message...">
                            <button id="send-group-message-btn" class="btn-primary rounded-l-none">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- People Page -->
            <div id="people-page" class="page">
                 <div class="max-w-3xl mx-auto">
                    <h1 class="text-3xl font-bold text-text-main mb-6">People</h1>
                    <div class="flex border-b border-accent mb-4">
                        <div id="people-tab-messages" class="people-tab active" onclick="window.switchPeopleTab('messages')">Messages</div>
                        <div id="people-tab-friends" class="people-tab" onclick="window.switchPeopleTab('friends')">Friends</div>
                        <div id="people-tab-requests" class="people-tab" onclick="window.switchPeopleTab('requests')">Requests</div>
                        <div id="people-tab-find" class="people-tab" onclick="window.switchPeopleTab('find')">Find People</div>
                    </div>

                    <div id="messages-view">
                        <div id="conversations-view">
                            <div class="flex justify-end mb-4">
                                <button id="new-chat-btn" class="btn-primary text-sm !py-2 !px-3">New Chat</button>
                            </div>
                            <div id="conversations-container" class="space-y-3"></div>
                        </div>
                        <div id="chat-view" class="hidden h-[calc(100vh-220px)] flex flex-col">
                            <div class="flex items-center mb-4 p-2 bg-secondary rounded-t-xl">
                                <button id="back-to-conversations-btn" class="mr-4 text-highlight">&larr;</button>
                                <img id="chat-pic" src="" class="w-10 h-10 rounded-full mr-3">
                                <h2 id="chat-name" class="text-xl font-bold"></h2>
                            </div>
                            <div id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col"></div>
                            <div class="p-4 bg-secondary rounded-b-xl flex">
                                <input type="text" id="message-input" class="input-field flex-grow rounded-r-none" placeholder="Type a message...">
                                <button id="send-message-btn" class="btn-primary rounded-l-none">Send</button>
                            </div>
                        </div>
                    </div>

                    <div id="my-friends-view" class="hidden">
                        <div id="my-friends-list" class="space-y-3"></div>
                    </div>
                    <div id="friend-requests-view" class="hidden">
                        <div id="friend-requests-list" class="space-y-3"></div>
                    </div>
                    <div id="find-people-view" class="hidden">
                        <div class="relative mb-4">
                            <input id="search-users-input" class="input-field !pr-10" placeholder="Search by username...">
                            <svg class="absolute top-1/2 right-3 -translate-y-1/2 w-5 h-5 text-text-secondary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </div>
                        <div id="search-results-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>


            <!-- Profile Page -->
            <div id="profile-page" class="page">
                <div class="max-w-3xl mx-auto">
                    <div class="bg-secondary p-6 rounded-xl shadow-lg text-center">
                        <img id="profile-pic" src="https://placehold.co/128x128/1A1A1A/F9FAFB?text=U" class="w-32 h-32 rounded-full mx-auto mb-4 ring-4 ring-highlight">
                        <h2 id="profile-username" class="text-3xl font-bold">...</h2>
                        <p id="profile-email" class="text-text-secondary">...</p>
                        <div class="mt-4 text-lg">
                            <span class="font-bold text-text-main" id="profile-friends-count">0</span>
                            <span class="text-text-secondary">Friends</span>
                        </div>
                    </div>
                    <h3 class="text-2xl font-bold mt-10 mb-4">My Posts</h3>
                    <div id="my-posts-container" class="space-y-6">
                        <!-- User's posts -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-secondary/80 backdrop-blur-sm border-t border-accent">
            <div class="flex justify-around max-w-5xl mx-auto">
                <button data-page="home-page" class="nav-btn p-4 active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                </button>
                <button data-page="marketplace-page" class="nav-btn p-4">
                    <svg class="h-7 w-7 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </button>
                 <button data-page="groups-page" class="nav-btn p-4">
                    <svg class="h-7 w-7 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                </button>
                <button data-page="people-page" class="nav-btn p-4 relative">
                    <svg class="h-7 w-7 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span id="friend-requests-badge" class="absolute top-2 right-2 w-4 h-4 bg-danger text-white text-xs rounded-full hidden items-center justify-center"></span>
                </button>
                <button data-page="profile-page" class="nav-btn p-4">
                    <svg class="h-7 w-7 text-text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </button>
            </div>
        </nav>
    </div>
    
    <!-- Modals -->
    <div id="donate-modal" class="fixed inset-0 z-40 items-center justify-center hidden modal-backdrop">
        <div class="bg-secondary rounded-xl p-6 w-full max-w-sm m-4 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Donate to Author</h3>
            <input type="number" id="donate-amount" class="input-field mb-4" placeholder="Amount in $" min="1">
            <input type="hidden" id="donate-post-id">
            <div class="flex justify-end space-x-3">
                <button id="cancel-donation" class="bg-accent hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-donation" class="btn-primary">Donate</button>
            </div>
        </div>
    </div>
    
     <div id="comments-modal" class="fixed inset-0 z-40 items-center justify-center hidden modal-backdrop">
        <div class="bg-secondary rounded-xl p-6 w-full max-w-lg h-5/6 flex flex-col m-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">Comments</h3>
                <button id="close-comments-modal" class="text-3xl text-text-secondary hover:text-text-main">&times;</button>
            </div>
            <div id="comments-list" class="flex-grow overflow-y-auto space-y-4 pr-2"></div>
            <div class="mt-4 flex flex-shrink-0">
                <input type="text" id="comment-input" class="input-field rounded-r-none flex-grow" placeholder="Write a comment...">
                <input type="hidden" id="comment-post-id">
                <button id="submit-comment" class="btn-primary rounded-l-none">Send</button>
            </div>
        </div>
    </div>

    <div id="new-chat-modal" class="fixed inset-0 z-40 items-center justify-center hidden modal-backdrop">
        <div class="bg-secondary rounded-xl p-6 w-full max-w-lg h-5/6 flex flex-col m-4 shadow-2xl">
             <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">Start a new Chat</h3>
                <button id="close-new-chat-modal" class="text-3xl text-text-secondary hover:text-text-main">&times;</button>
            </div>
            <div id="friends-chat-list" class="flex-grow overflow-y-auto space-y-3">
                <!-- Friends list for new chat -->
            </div>
        </div>
    </div>

    <script>
        // --- Security: Disable Right-Click & Dev Tools ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function (e) {
            if (e.keyCode == 123) { return false; } // F12
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } // Ctrl+Shift+I
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; } // Ctrl+Shift+C
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; } // Ctrl+Shift+J
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } // Ctrl+U
        };
    </script>
    <script type="module">
        // Import a Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot,
            serverTimestamp,
            doc,
            updateDoc,
            arrayUnion,
            arrayRemove,
            getDoc,
            where,
            getDocs,
            increment,
            runTransaction,
            setDoc,
            deleteDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBD202YQyRGa7PUE9kh8o-bQQciAO8Lwc8",
            authDomain: "glowearth-f0801.firebaseapp.com",
            projectId: "glowearth-f0801",
            storageBucket: "glowearth-f0801.firebasestorage.app",
            messagingSenderId: "11001317302",
            appId: "1:11001317302:web:db00d5dd1cf0fabf862317"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUser = null;
        let userData = null;
        let activeChatId = null;
        let activeGroupId = null;
        let messageUnsubscribe = null;
        let groupMessageUnsubscribe = null;

        // DOM Elements
        const loader = document.getElementById('loader');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');

        // View switching
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden');
        });
        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden');
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                
                onSnapshot(userDocRef, (doc) => {
                     if (doc.exists()) {
                        userData = { id: user.uid, ...doc.data() };
                        setupProfilePage();
                        loadMyFriends();
                    } else {
                        console.error("User data not found in Firestore!");
                        userData = { id: user.uid, username: user.displayName, email: user.email, profilePictureUrl: user.photoURL || `https://placehold.co/128x128/1A1A1A/F9FAFB?text=${user.displayName?.charAt(0).toUpperCase()}`, friends: [], friendRequestsSent: [] };
                    }
                });

                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadInitialData();
            } else {
                currentUser = null; userData = null;
                authContainer.classList.remove('hidden'); appContainer.classList.add('hidden');
            }
            loader.classList.add('hidden');
        });
        
        function loadInitialData() {
            loadPosts();
            loadMarketplaceItems();
            loadMyPosts();
            loadConversations();
            loadGroups();
            loadFriendRequests();
        }

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => document.getElementById('login-error').textContent = error.message);
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
             if (!username) {
                document.getElementById('register-error').textContent = "Username cannot be empty.";
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: username });
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, {
                    username: username,
                    username_lowercase: username.toLowerCase(),
                    email: email,
                    createdAt: serverTimestamp(),
                    profilePictureUrl: `https://placehold.co/128x128/1A1A1A/F9FAFB?text=${username.charAt(0).toUpperCase()}`,
                    friends: [],
                    friendRequestsSent: []
                });
            } catch (error) {
                document.getElementById('register-error').textContent = error.message;
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page');
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pageId = button.dataset.page;
                pages.forEach(page => page.classList.toggle('active', page.id === pageId));
                navButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.querySelector('svg').classList.add('text-text-secondary');
                });
                button.classList.add('active');
                button.querySelector('svg').classList.remove('text-text-secondary');
            });
        });

        // --- POSTS ---
        const postsContainer = document.getElementById('posts-container');
        document.getElementById('create-post-btn').addEventListener('click', async () => {
            const content = document.getElementById('post-content').value.trim();
            if (content && currentUser) {
                await addDoc(collection(db, 'posts'), {
                    authorId: currentUser.uid, authorUsername: userData.username, authorProfilePic: userData.profilePictureUrl,
                    content: content, timestamp: serverTimestamp(), likes: [], donations: 0, commentsCount: 0,
                });
                document.getElementById('post-content').value = '';
            }
        });

        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                postsContainer.innerHTML = '';
                snapshot.forEach((doc) => postsContainer.innerHTML += createPostHTML({ id: doc.id, ...doc.data() }));
            });
        }
        
        function createPostHTML(post) {
            const isLiked = post.likes && post.likes.includes(currentUser.uid);
            const timeAgo = post.timestamp ? timeSince(post.timestamp.toDate()) : 'just now';
            return `<div class="bg-secondary p-5 rounded-xl shadow-lg animate-fadeIn">
                    <div class="flex items-center mb-4"><img src="${post.authorProfilePic}" class="w-12 h-12 rounded-full mr-4"><div><p class="font-bold text-text-main">${post.authorUsername}</p><p class="text-xs text-text-secondary">${timeAgo}</p></div></div>
                    <p class="text-text-main mb-4 whitespace-pre-wrap">${post.content}</p>
                    <div class="flex justify-between items-center text-text-secondary border-t border-accent pt-3">
                        <button class="flex items-center space-x-2 hover:text-highlight transition-colors" onclick="window.toggleLike('${post.id}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform ${isLiked ? 'text-danger fill-current transform scale-110' : ''}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg><span class="font-medium">${post.likes ? post.likes.length : 0}</span></button>
                        <button class="flex items-center space-x-2 hover:text-highlight transition-colors" onclick="window.openComments('${post.id}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.08-3.239A8.962 8.962 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.5 10a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z" clip-rule="evenodd" /></svg><span class="font-medium">${post.commentsCount || 0}</span></button>
                        <button class="flex items-center space-x-2 hover:text-highlight transition-colors" onclick="window.openDonateModal('${post.id}')"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 14v1m0-1c-1.11 0-2.08-.402-2.599-1M12 14c-1.657 0-3-.895-3-2s1.343-2 3-2m0 8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 14v1m0-1c-1.11 0-2.08-.402-2.599-1" /></svg><span class="font-medium">$${post.donations || 0}</span></button>
                    </div></div>`;
        }

        window.toggleLike = async (postId) => {
            if (!currentUser) return;
            const postRef = doc(db, "posts", postId);
            const postDoc = await getDoc(postRef);
            if (postDoc.exists()) {
                const postData = postDoc.data();
                if (postData.likes && postData.likes.includes(currentUser.uid)) {
                    await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
                } else {
                    await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
                }
            }
        };

        // --- MODALS (Donate, Comments, New Chat) ---
        const donateModal = document.getElementById('donate-modal');
        const commentsModal = document.getElementById('comments-modal');
        const newChatModal = document.getElementById('new-chat-modal');
        window.openDonateModal = (postId) => {
            document.getElementById('donate-post-id').value = postId; donateModal.style.display = 'flex';
        };
        document.getElementById('cancel-donation').addEventListener('click', () => { donateModal.style.display = 'none'; });
        document.getElementById('confirm-donation').addEventListener('click', async () => {
            const postId = document.getElementById('donate-post-id').value;
            const amount = parseFloat(document.getElementById('donate-amount').value);
            if (postId && amount > 0) {
                await updateDoc(doc(db, "posts", postId), { donations: increment(amount) });
                document.getElementById('donate-amount').value = ''; donateModal.style.display = 'none';
            }
        });
        window.openComments = (postId) => {
            document.getElementById('comment-post-id').value = postId; loadComments(postId); commentsModal.style.display = 'flex';
        };
        document.getElementById('close-comments-modal').addEventListener('click', () => { commentsModal.style.display = 'none'; });
        document.getElementById('submit-comment').addEventListener('click', async () => {
             const postId = document.getElementById('comment-post-id').value;
             const text = document.getElementById('comment-input').value.trim();
             if(text){
                 await addDoc(collection(db, 'posts', postId, 'comments'), {
                     authorId: currentUser.uid, authorUsername: userData.username, text: text, timestamp: serverTimestamp()
                 });
                 await updateDoc(doc(db, 'posts', postId), { commentsCount: increment(1) });
                 document.getElementById('comment-input').value = '';
             }
        });
        function loadComments(postId) {
            const q = query(collection(db, 'posts', postId, 'comments'), orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('comments-list');
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    list.innerHTML += `<div class="bg-accent/50 p-3 rounded-lg"><div class="flex justify-between items-baseline"><p class="font-semibold text-sm text-highlight">${comment.authorUsername}</p><p class="text-xs text-text-secondary">${timeSince(comment.timestamp.toDate())}</p></div><p class="text-text-main mt-1">${comment.text}</p></div>`;
                });
                list.scrollTop = list.scrollHeight;
            });
        }
        document.getElementById('new-chat-btn').addEventListener('click', async () => {
            const friendsListContainer = document.getElementById('friends-chat-list');
            friendsListContainer.innerHTML = 'Loading friends...';
            if (!userData || !userData.friends || userData.friends.length === 0) {
                friendsListContainer.innerHTML = `<p class="text-text-secondary text-center">You have no friends to chat with. Add some!</p>`;
                newChatModal.style.display = 'flex';
                return;
            }
            const friendsQuery = query(collection(db, 'users'), where('__name__', 'in', userData.friends));
            const friendsSnapshot = await getDocs(friendsQuery);
            friendsListContainer.innerHTML = '';
            friendsSnapshot.forEach(doc => {
                 const friend = { id: doc.id, ...doc.data() };
                 friendsListContainer.innerHTML += `<div onclick="window.startChat('${friend.id}')" class="flex items-center p-3 hover:bg-accent rounded-lg cursor-pointer"><img src="${friend.profilePictureUrl}" class="w-10 h-10 rounded-full mr-3"><p>${friend.username}</p></div>`;
            });
            newChatModal.style.display = 'flex';
        });
        document.getElementById('close-new-chat-modal').addEventListener('click', () => { newChatModal.style.display = 'none'; });
        
        // --- MESSAGES (inside People Page) ---
        const conversationsContainer = document.getElementById('conversations-container');
        const chatView = document.getElementById('chat-view');
        const conversationsView = document.getElementById('conversations-view');
        
        window.startChat = async (otherUserId) => {
            const chatId = currentUser.uid < otherUserId ? `${currentUser.uid}_${otherUserId}` : `${otherUserId}_${currentUser.uid}`;
            const chatRef = doc(db, 'chats', chatId);
            const chatSnap = await getDoc(chatRef);
            if (!chatSnap.exists()) {
                await setDoc(chatRef, {
                    members: [currentUser.uid, otherUserId],
                    lastMessage: serverTimestamp()
                });
            }
            newChatModal.style.display = 'none';
            // Switch to people tab and open conversation
            document.querySelector('[data-page="people-page"]').click();
            openConversation(chatId);
        };

        function loadConversations() {
            const q = query(collection(db, 'chats'), where('members', 'array-contains', currentUser.uid));
            onSnapshot(q, async (snapshot) => {
                if (snapshot.empty) {
                    conversationsContainer.innerHTML = `<p class="text-text-secondary text-center mt-10">No conversations yet. Start a new one with a friend!</p>`;
                    return;
                }
                
                let conversations = [];
                snapshot.forEach(doc => conversations.push({ id: doc.id, ...doc.data() }));
                conversations.sort((a, b) => (b.lastMessage?.toDate() || 0) - (a.lastMessage?.toDate() || 0));

                let html = '';
                for (const chat of conversations) {
                    const otherUserId = chat.members.find(id => id !== currentUser.uid);
                    if (otherUserId) {
                        const userSnap = await getDoc(doc(db, 'users', otherUserId));
                        if (userSnap.exists()){
                            const otherUser = userSnap.data();
                            html += `<div onclick="window.openConversation('${chat.id}')" class="flex items-center p-3 hover:bg-accent rounded-lg cursor-pointer"><img src="${otherUser.profilePictureUrl}" class="w-12 h-12 rounded-full mr-4"><div><p class="font-bold">${otherUser.username}</p><p class="text-sm text-text-secondary">Click to open chat</p></div></div>`;
                        }
                    }
                }
                conversationsContainer.innerHTML = html;
            });
        }
        window.openConversation = async (chatId) => {
            if (messageUnsubscribe) messageUnsubscribe();
            activeChatId = chatId;
            conversationsView.classList.add('hidden');
            chatView.classList.remove('hidden');
            const chatDoc = await getDoc(doc(db, 'chats', chatId));
            const otherUserId = chatDoc.data().members.find(id => id !== currentUser.uid);
            const userSnap = await getDoc(doc(db, 'users', otherUserId));
            const otherUser = userSnap.data();
            document.getElementById('chat-name').innerText = otherUser.username;
            document.getElementById('chat-pic').src = otherUser.profilePictureUrl;

            const messagesContainer = document.getElementById('messages-container');
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            messageUnsubscribe = onSnapshot(q, snapshot => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const bubbleClass = msg.senderId === currentUser.uid ? 'chat-bubble-sent' : 'chat-bubble-received';
                    messagesContainer.innerHTML += `<div class="p-3 rounded-xl max-w-xs ${bubbleClass}">${msg.text}</div>`;
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        };
        document.getElementById('send-message-btn').addEventListener('click', async () => {
            const text = document.getElementById('message-input').value.trim();
            if (text && activeChatId) {
                await addDoc(collection(db, 'chats', activeChatId, 'messages'), {
                    senderId: currentUser.uid, text: text, timestamp: serverTimestamp()
                });
                await updateDoc(doc(db, 'chats', activeChatId), { lastMessage: serverTimestamp() });
                document.getElementById('message-input').value = '';
            }
        });
        document.getElementById('back-to-conversations-btn').addEventListener('click', () => {
            if (messageUnsubscribe) messageUnsubscribe();
            activeChatId = null;
            chatView.classList.add('hidden');
            conversationsView.classList.remove('hidden');
        });

        // --- GROUPS ---
        const groupsListView = document.getElementById('groups-list-view');
        const createGroupView = document.getElementById('create-group-view');
        const groupChatView = document.getElementById('group-chat-view');
        document.getElementById('show-create-group-btn').addEventListener('click', () => {
            groupsListView.classList.add('hidden'); createGroupView.classList.remove('hidden');
        });
        document.getElementById('cancel-create-group-btn').addEventListener('click', () => {
            createGroupView.classList.add('hidden'); groupsListView.classList.remove('hidden');
        });
        document.getElementById('create-group-btn').addEventListener('click', async () => {
            const name = document.getElementById('group-name').value.trim();
            const description = document.getElementById('group-description').value.trim();
            if(name){
                await addDoc(collection(db, 'groups'), {
                    name: name, description: description, createdAt: serverTimestamp(),
                    creatorId: currentUser.uid, members: [currentUser.uid], lastMessage: serverTimestamp()
                });
                document.getElementById('group-name').value = '';
                document.getElementById('group-description').value = '';
                createGroupView.classList.add('hidden');
                groupsListView.classList.remove('hidden');
            }
        });

        function loadGroups() {
            const q = query(collection(db, 'groups'), where('members', 'array-contains', currentUser.uid));
            onSnapshot(q, snapshot => {
                const container = document.getElementById('my-groups-container');
                if(!container) return;
                
                let groups = [];
                snapshot.forEach(doc => {
                    groups.push({ id: doc.id, ...doc.data() });
                });
                groups.sort((a, b) => (b.lastMessage?.toDate() || 0) - (a.lastMessage?.toDate() || 0));

                if(groups.length === 0) {
                    container.innerHTML = `<p class="text-text-secondary text-center mt-10">You are not in any group. Create one!</p>`;
                    return;
                }
                
                container.innerHTML = '';
                groups.forEach(group => {
                    container.innerHTML += `<div onclick="window.openGroup('${group.id}')" class="flex items-center p-3 hover:bg-accent rounded-lg cursor-pointer"><div class="w-12 h-12 rounded-full mr-4 bg-accent flex items-center justify-center font-bold text-xl">${group.name.charAt(0)}</div><div><p class="font-bold">${group.name}</p><p class="text-sm text-text-secondary">${group.description.substring(0, 30)}...</p></div></div>`;
                });
            });
        }
        window.openGroup = async (groupId) => {
            if (groupMessageUnsubscribe) groupMessageUnsubscribe();
            activeGroupId = groupId;
            groupsListView.classList.add('hidden');
            groupChatView.classList.remove('hidden');
            const groupDoc = await getDoc(doc(db, 'groups', groupId));
            const group = groupDoc.data();
            document.getElementById('group-chat-name').innerText = group.name;
            document.getElementById('group-chat-pic').src = `https://placehold.co/128x128/1A1A1A/F9FAFB?text=${group.name.charAt(0)}`;
            
            const messagesContainer = document.getElementById('group-messages-container');
            const messagesRef = collection(db, 'groups', groupId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));
            groupMessageUnsubscribe = onSnapshot(q, snapshot => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const bubbleClass = msg.senderId === currentUser.uid ? 'chat-bubble-sent' : 'chat-bubble-received';
                    const senderName = msg.senderId === currentUser.uid ? '' : `<p class="text-xs text-highlight mb-1">${msg.senderUsername}</p>`;
                    messagesContainer.innerHTML += `<div class="p-3 rounded-xl max-w-xs ${bubbleClass}">${senderName}${msg.text}</div>`;
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        };
        document.getElementById('send-group-message-btn').addEventListener('click', async () => {
            const text = document.getElementById('group-message-input').value.trim();
            if(text && activeGroupId){
                 await addDoc(collection(db, 'groups', activeGroupId, 'messages'), {
                    senderId: currentUser.uid, senderUsername: userData.username, text: text, timestamp: serverTimestamp()
                });
                await updateDoc(doc(db, 'groups', activeGroupId), { lastMessage: serverTimestamp() });
                document.getElementById('group-message-input').value = '';
            }
        });
        document.getElementById('back-to-groups-btn').addEventListener('click', () => {
            if (groupMessageUnsubscribe) groupMessageUnsubscribe();
            activeGroupId = null;
            groupChatView.classList.add('hidden');
            groupsListView.classList.remove('hidden');
        });

        // --- FRIENDS (inside People page) ---
        const peopleTabs = {
            messages: document.getElementById('messages-view'),
            friends: document.getElementById('my-friends-view'),
            requests: document.getElementById('friend-requests-view'),
            find: document.getElementById('find-people-view')
        };
        window.switchPeopleTab = (tab) => {
            Object.values(peopleTabs).forEach(view => view.classList.add('hidden'));
            document.querySelectorAll('.people-tab').forEach(t => t.classList.remove('active'));
            peopleTabs[tab].classList.remove('hidden');
            document.getElementById(`people-tab-${tab}`).classList.add('active');
        };

        async function loadMyFriends() {
            const container = document.getElementById('my-friends-list');
            if (!userData || !userData.friends || userData.friends.length === 0) {
                container.innerHTML = `<p class="text-text-secondary text-center">You haven't added any friends yet.</p>`;
                return;
            }
            const friendsQuery = query(collection(db, 'users'), where('__name__', 'in', userData.friends));
            const friendsSnapshot = await getDocs(friendsQuery);
            container.innerHTML = '';
            friendsSnapshot.forEach(doc => {
                const friend = { id: doc.id, ...doc.data() };
                container.innerHTML += `<div class="flex items-center justify-between p-3 bg-accent rounded-lg">
                    <div class="flex items-center"><img src="${friend.profilePictureUrl}" class="w-10 h-10 rounded-full mr-3"><p>${friend.username}</p></div>
                    <button class="btn-primary !py-1 !px-3 text-sm" onclick="window.startChat('${friend.id}')">Message</button>
                </div>`;
            });
        }

        function loadFriendRequests() {
            const requestsRef = collection(db, 'users', currentUser.uid, 'friendRequests');
            const q = query(requestsRef, where('status', '==', 'pending'));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('friend-requests-list');
                const badge = document.getElementById('friend-requests-badge');
                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-text-secondary text-center">No new friend requests.</p>`;
                    badge.classList.add('hidden');
                    return;
                }
                badge.classList.remove('hidden');
                badge.textContent = snapshot.size;
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const req = { id: doc.id, ...doc.data() };
                    container.innerHTML += `<div class="flex items-center justify-between p-3 bg-accent rounded-lg">
                        <div class="flex items-center"><img src="${req.senderProfilePic}" class="w-10 h-10 rounded-full mr-3"><p>${req.senderUsername}</p></div>
                        <div class="flex space-x-2">
                            <button class="bg-success hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg" onclick="window.acceptFriendRequest('${req.senderId}')">Accept</button>
                            <button class="bg-danger hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg" onclick="window.declineFriendRequest('${req.senderId}')">Decline</button>
                        </div>
                    </div>`;
                });
            });
        }
        
        window.sendFriendRequest = async (recipientId) => {
            const requestRef = doc(db, 'users', recipientId, 'friendRequests', currentUser.uid);
            await setDoc(requestRef, {
                senderId: currentUser.uid,
                senderUsername: userData.username,
                senderProfilePic: userData.profilePictureUrl,
                status: 'pending',
                createdAt: serverTimestamp()
            });
            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, { friendRequestsSent: arrayUnion(recipientId) });
            document.getElementById(`add-friend-btn-${recipientId}`).textContent = 'Request Sent';
            document.getElementById(`add-friend-btn-${recipientId}`).disabled = true;
        };

        window.acceptFriendRequest = async (senderId) => {
            const batch = writeBatch(db);
            const currentUserRef = doc(db, 'users', currentUser.uid);
            batch.update(currentUserRef, { friends: arrayUnion(senderId) });
            const senderRef = doc(db, 'users', senderId);
            batch.update(senderRef, { friends: arrayUnion(currentUser.uid), friendRequestsSent: arrayRemove(currentUser.uid) });
            const requestRef = doc(db, 'users', currentUser.uid, 'friendRequests', senderId);
            batch.delete(requestRef);
            await batch.commit();
        };

        window.declineFriendRequest = async (senderId) => {
             const batch = writeBatch(db);
             const requestRef = doc(db, 'users', currentUser.uid, 'friendRequests', senderId);
             batch.delete(requestRef);
             const senderRef = doc(db, 'users', senderId);
             batch.update(senderRef, { friendRequestsSent: arrayRemove(currentUser.uid) });
             await batch.commit();
        };
        
        document.getElementById('search-users-input').addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results-list');
            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where('username_lowercase', '>=', searchTerm), where('username_lowercase', '<=', searchTerm + '\uf8ff'));
            const userSnapshot = await getDocs(q);
            resultsContainer.innerHTML = '';
            userSnapshot.forEach(doc => {
                const user = {id: doc.id, ...doc.data()};
                if (user.id === currentUser.uid) return;
                
                let buttonHtml = `<button id="add-friend-btn-${user.id}" class="btn-primary !py-1 !px-3 text-sm" onclick="window.sendFriendRequest('${user.id}')">Add Friend</button>`;
                if (userData.friends && userData.friends.includes(user.id)) {
                    buttonHtml = `<span class="text-sm font-medium text-success">Friends</span>`;
                } else if (userData.friendRequestsSent && userData.friendRequestsSent.includes(user.id)) {
                    buttonHtml = `<button id="add-friend-btn-${user.id}" class="btn-primary !py-1 !px-3 text-sm" disabled>Request Sent</button>`;
                }

                resultsContainer.innerHTML += `<div class="flex items-center justify-between p-3 bg-accent rounded-lg">
                    <div class="flex items-center"><img src="${user.profilePictureUrl}" class="w-10 h-10 rounded-full mr-3"><p>${user.username}</p></div>
                    ${buttonHtml}
                </div>`;
            });
        });

        // --- MARKETPLACE & PROFILE ---
        function loadMarketplaceItems() {
             const q = query(collection(db, 'marketplace'), orderBy('createdAt', 'desc'));
             onSnapshot(q, (snapshot) => {
                const container = document.getElementById('marketplace-items-container');
                container.innerHTML = '';
                snapshot.forEach(doc => {
                    const item = {id: doc.id, ...doc.data()};
                    container.innerHTML += `<div class="bg-secondary p-4 rounded-xl shadow-lg transition-transform hover:scale-105"><div class="bg-accent h-48 w-full rounded-lg mb-4 flex items-center justify-center text-text-secondary">Item Image</div><h3 class="font-bold text-lg text-text-main truncate">${item.name}</h3><p class="font-semibold text-xl" style="background: linear-gradient(90deg, rgba(0,251,255,1) 0%, rgba(0,42,250,1) 50%, rgba(255,0,212,1) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">$${item.price}</p><p class="text-text-secondary text-sm h-10 overflow-hidden mb-2">${item.description}</p><p class="text-xs text-text-secondary">Sold by: ${item.sellerUsername}</p></div>`;
                });
             });
        }
        document.getElementById('add-item-btn').addEventListener('click', async () => {
            const name = document.getElementById('item-name').value, desc = document.getElementById('item-description').value, price = parseFloat(document.getElementById('item-price').value);
            if(name && desc && price > 0){
                 await addDoc(collection(db, 'marketplace'), {
                    sellerId: currentUser.uid, sellerUsername: userData.username, name: name, description: desc, price: price, createdAt: serverTimestamp()
                 });
                 document.getElementById('item-name').value = ''; document.getElementById('item-description').value = ''; document.getElementById('item-price').value = '';
            }
        });
        function setupProfilePage() {
            if(userData) {
                document.getElementById('profile-pic').src = userData.profilePictureUrl;
                document.getElementById('profile-username').textContent = userData.username;
                document.getElementById('profile-email').textContent = userData.email;
                document.getElementById('profile-friends-count').textContent = userData.friends ? userData.friends.length : 0;
            }
        }
        function loadMyPosts() {
            if (!currentUser) return;
            const q = query(collection(db, 'posts'), where('authorId', '==', currentUser.uid));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('my-posts-container');
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-text-secondary text-center">You haven't posted anything yet.</p>`;
                } else {
                    const posts = []; snapshot.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
                    posts.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                    posts.forEach(post => container.innerHTML += createPostHTML(post));
                }
            });
        }
        
        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago";
            return "just now";
        }
    </script>
</body>
</html>

