<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kripto Sniper Bot - Solana Edition v6.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .log-entry-new { animation: fadeIn 0.5s ease-out; }
        .stat-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .btn-disabled { cursor: not-allowed; background-color: #4b5563; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 min-h-screen flex flex-col">

        <div class="relative mb-8 text-center">
            <header>
                <h1 class="text-4xl font-bold text-white mb-2">Kripto Sniper Bot <span class="text-cyan-400">Solana v6.1</span></h1>
                <p class="text-lg text-gray-400">Aplikacija z Integracijo Phantom Denarnice</p>
            </header>
            <div class="absolute top-0 right-0">
                <button id="connect-wallet-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                    Pove≈æi Denarnico
                </button>
            </div>
        </div>

        <!-- STATISTIKA -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-gray-800 shadow-lg rounded-2xl p-6"><h3 class="text-sm font-medium text-gray-400 uppercase">Stanje Denarnice</h3><p id="wallet-balance" class="text-3xl font-bold text-white mt-2">... SOL</p></div>
            <div class="stat-card bg-gray-800 shadow-lg rounded-2xl p-6"><h3 class="text-sm font-medium text-gray-400 uppercase">Realiziran Dobiƒçek (PnL)</h3><p id="pnl-value" class="text-3xl font-bold text-gray-400 mt-2">+0.00 SOL</p></div>
            <div class="stat-card bg-gray-800 shadow-lg rounded-2xl p-6"><h3 class="text-sm font-medium text-gray-400 uppercase">Opravljeni Posli</h3><p id="trade-count" class="text-3xl font-bold text-white mt-2">0</p></div>
            <div class="stat-card bg-gray-800 shadow-lg rounded-2xl p-6"><h3 class="text-sm font-medium text-gray-400 uppercase">Uspe≈°nost</h3><p id="win-rate" class="text-3xl font-bold text-white mt-2">N/A</p></div>
        </div>

        <!-- NADZORNA PLO≈†ƒåA IN STANJE -->
        <div class="bg-gray-800 shadow-lg rounded-2xl p-6 mb-8 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
            <div class="flex items-center space-x-4">
                <span id="connection-status" class="text-lg font-medium text-gray-400">Pripravljen</span>
                <div id="status-indicator" class="flex items-center space-x-2 px-4 py-2 rounded-full bg-red-500/20 text-red-300 transition-colors duration-300"><div id="status-dot" class="w-3 h-3 rounded-full bg-red-500 transition-colors duration-300"></div><span id="status-text" class="font-semibold">Ustavljen</span></div>
            </div>
            <button id="toggle-bot-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300" disabled>
                üöÄ Pove≈æi denarnico za zagon
            </button>
        </div>

        <!-- GLAVNA VSEBINA -->
        <div class="flex-grow grid grid-cols-1 lg:grid-cols-5 gap-8">
            <main class="lg:col-span-3 flex flex-col bg-gray-800 shadow-lg rounded-2xl overflow-hidden">
                <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-semibold text-white">Dnevnik Dogodkov</h2></div>
                <div id="log-container" class="flex-grow p-6 space-y-4 overflow-y-auto"><div class="text-center text-gray-500 pt-10">Dnevnik je prazen. Pove≈æi denarnico in za≈æeni bota.</div></div>
            </main>
            <aside class="lg:col-span-2 flex flex-col bg-gray-800 shadow-lg rounded-2xl overflow-hidden">
                <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-semibold text-white">Odprte Pozicije</h2></div>
                <div id="positions-container" class="flex-grow p-6 overflow-y-auto"><div id="no-positions-msg" class="text-center text-gray-500 pt-10">Trenutno ni odprtih pozicij.</div></div>
            </aside>
        </div>

        <footer class="text-center py-6 text-gray-500 text-sm mt-8"><p>&copy; 2025 - Samostojni Kripto Sniper Bot.</p></footer>
    </div>

    <script>
        // --- DOM ELEMENTI ---
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const toggleBtn = document.getElementById('toggle-bot-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const connectionStatusEl = document.getElementById('connection-status');
        const logContainer = document.getElementById('log-container');
        const positionsContainer = document.getElementById('positions-container');
        const noPositionsMsg = document.getElementById('no-positions-msg');
        const walletBalanceEl = document.getElementById('wallet-balance');
        const pnlValueEl = document.getElementById('pnl-value');
        const tradeCountEl = document.getElementById('trade-count');
        const winRateEl = document.getElementById('win-rate');

        // --- KONFIGURACIJA BOTA (SOLANA) ---
        const SOLANA_NODE_URL = "wss://api.mainnet-beta.solana.com";
        const RAYDIUM_LIQUIDITY_PROGRAM_ID = "675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8";
        const WSOL_ADDRESS = "So11111111111111111111111111111111111111112";
        const BUY_AMOUNT_SOL = 0.05;

        // --- STANJE APLIKACIJE ---
        let isRunning = false;
        let priceSimInterval;
        let connection;
        let logsSubscriptionId;
        let phantomProvider;
        let userAddress;
        
        let state = {
            walletBalance: 0.0,
            pnl: 0.0,
            trades: 0,
            wins: 0,
            positions: new Map()
        };

        // --- FUNKCIJE ZA PRIKAZ (UI) ---
        function formatNumber(num) { return (typeof num === 'number') ? num.toFixed(4) : '0.0000'; }

        function updateStats() {
            if (!userAddress) {
                walletBalanceEl.textContent = '... SOL';
                pnlValueEl.textContent = '+0.00 SOL';
                tradeCountEl.textContent = '0';
                winRateEl.textContent = 'N/A';
                return;
            }
            walletBalanceEl.textContent = `${formatNumber(state.walletBalance)} SOL`;
            pnlValueEl.textContent = `${state.pnl >= 0 ? '+' : ''}${formatNumber(state.pnl)} SOL`;
            pnlValueEl.className = `text-3xl font-bold mt-2 ${state.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            tradeCountEl.textContent = state.trades;
            if (state.trades > 0) {
                const rate = (state.wins / state.trades) * 100;
                winRateEl.textContent = `${rate.toFixed(1)}%`;
            } else {
                winRateEl.textContent = 'N/A';
            }
        }

        function renderPositions() {
            if (state.positions.size === 0) {
                noPositionsMsg.style.display = 'block';
                positionsContainer.innerHTML = '';
                positionsContainer.appendChild(noPositionsMsg);
                noPositionsMsg.textContent = 'Trenutno ni odprtih pozicij.';
                return;
            }
            noPositionsMsg.style.display = 'none';
            positionsContainer.innerHTML = '';

            for (const [address, pos] of state.positions.entries()) {
                const pnl = (pos.currentValue - pos.buyValue);
                const pnlPercent = (pnl / pos.buyValue) * 100;
                const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';

                const positionCard = document.createElement('div');
                positionCard.className = 'bg-gray-700/50 p-4 rounded-lg mb-4';
                positionCard.innerHTML = `<div class="flex justify-between items-center mb-2"><h4 class="font-bold text-white truncate" title="${address}">${pos.symbol}</h4><span class="font-mono text-sm ${pnlColor}">${pnl >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%</span></div><div class="font-mono text-xs text-gray-400 space-y-1"><p><strong>Vrednost:</strong> ${formatNumber(pos.currentValue)} SOL</p><p><strong>PnL:</strong> <span class="${pnlColor}">${pnl >= 0 ? '+' : ''}${formatNumber(pnl)} SOL</span></p></div>`;
                positionsContainer.appendChild(positionCard);
            }
        }
        
        function logEntry(message, type = 'system', data = {}) {
            if (logContainer.querySelector('.text-gray-500')) logContainer.innerHTML = '';
            const entry = document.createElement('div');
            entry.className = 'p-4 rounded-lg log-entry-new font-mono text-sm';
            const timestamp = new Date().toLocaleTimeString('sl-SI');
            let content = '', header = '';
            const typeClasses = {
                system: { bg: 'bg-blue-500/10', text: 'text-blue-300', tag: 'SISTEM' },
                wallet: { bg: 'bg-cyan-500/10', text: 'text-cyan-300', tag: 'DENARNICA' },
                pair: { bg: 'bg-gray-700/50', text: 'text-gray-300', tag: 'NOV PAR' },
                buy: { bg: 'bg-green-500/10', text: 'text-green-300', tag: 'NAKUP' },
                sell: { bg: 'bg-indigo-500/10', text: 'text-indigo-300', tag: 'PRODAJA' },
                error: { bg: 'bg-red-500/10', text: 'text-red-300', tag: 'NAPAKA' }
            };
            const c = typeClasses[type] || typeClasses.system;
            entry.classList.add(c.bg);
            header = `<span class="text-xs font-bold px-2 py-1 rounded-full ${c.bg.replace('/10','/20')} ${c.text}">${c.tag}</span>`;
            
            switch(type) {
                case 'system': content = `<span class="font-semibold">${message}</span>`; break;
                case 'wallet': content = `<span class="font-semibold">${message}</span><p class="text-xs text-gray-500 break-all mt-1">Naslov: ${data.address}</p>`; break;
                case 'pair':
                    content = `<p class="mb-2"><strong>Zaznan nov likvidnostni par na Raydiumu!</strong></p><p class="text-xs text-gray-500 break-all">Signature: ${data.signature.substring(0, 30)}...</p>`;
                    break;
                case 'buy': content = `<p class="mb-1"><strong>Kovanec:</strong> <span class="text-cyan-400">${data.symbol} (${data.address.substring(0,10)}...)</span></p><p><strong>Znesek:</strong> ${formatNumber(data.amount)} SOL</p>`; break;
                case 'sell':
                    const pnlColor = data.pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    content = `<p class="mb-1"><strong>Kovanec:</strong> <span class="text-cyan-400">${data.symbol}</span></p><p><strong>Dobiƒçek/Izguba:</strong> <span class="${pnlColor}">${data.pnl >= 0 ? '+' : ''}${formatNumber(data.pnl)} SOL</span></p>`;
                    break;
                case 'error': content = `<span class="font-semibold text-red-400">${message}</span>`; break;
            }
            entry.innerHTML = `<div class="flex justify-between items-center mb-2">${header}<span class="text-xs text-gray-500">${timestamp}</span></div><div>${content}</div>`;
            logContainer.prepend(entry);
            if (logContainer.children.length > 200) logContainer.removeChild(logContainer.lastChild);
        }
        
        function updateBotStatus(running) {
            isRunning = running;
            if (isRunning) {
                statusIndicator.className = 'flex items-center space-x-2 px-4 py-2 rounded-full bg-green-500/20 text-green-300';
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                statusText.textContent = 'Deluje';
                toggleBtn.innerHTML = 'üõë Ustavi Bota';
                toggleBtn.className = 'w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105';
            } else {
                statusIndicator.className = 'flex items-center space-x-2 px-4 py-2 rounded-full bg-red-500/20 text-red-300';
                statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'Ustavljen';
                toggleBtn.innerHTML = userAddress ? 'üöÄ Za≈æeni Bota' : 'üöÄ Pove≈æi denarnico za zagon';
                toggleBtn.className = userAddress ? 'w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105' : 'w-full sm:w-auto bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-md btn-disabled';
            }
        }
        
        // --- LOGIKA BOTA ---
        function simulatePriceChangesAndSells() {
            if (!isRunning || state.positions.size === 0) return;
            const positionsToSell = [];
            for (const [address, pos] of state.positions.entries()) {
                const change = (Math.random() - 0.48) * 0.2;
                pos.currentValue *= (1 + change);
                const pnl = pos.currentValue - pos.buyValue;
                if (pnl > pos.buyValue * 0.5 || pnl < -pos.buyValue * 0.25) {
                    positionsToSell.push(address);
                }
            }
            if (positionsToSell.length > 0) {
                for (const address of positionsToSell) {
                    const pos = state.positions.get(address);
                    const pnl = pos.currentValue - pos.buyValue;
                    state.walletBalance += pos.currentValue;
                    state.pnl += pnl;
                    state.trades++;
                    if (pnl > 0) state.wins++;
                    logEntry('', 'sell', { symbol: pos.symbol, pnl: pnl });
                    state.positions.delete(address);
                }
                updateStats();
                renderPositions();
            }
        }

        function handleNewLog(logInfo, context) {
            const signature = logInfo.signature;
            const logMessages = logInfo.logs.join(' ');
            if (logMessages.includes("initialize2")) {
                 logEntry('', 'pair', { signature });
                if (Math.random() < 0.1 && state.walletBalance >= BUY_AMOUNT_SOL) {
                    const placeholderAddress = signature.substring(0, 20);
                    const symbol = "SOLCOIN" + Math.floor(Math.random() * 9000 + 1000);
                    state.walletBalance -= BUY_AMOUNT_SOL;
                    state.positions.set(placeholderAddress, { symbol: symbol, buyValue: BUY_AMOUNT_SOL, currentValue: BUY_AMOUNT_SOL });
                    logEntry('', 'buy', { symbol: symbol, address: placeholderAddress, amount: BUY_AMOUNT_SOL });
                    updateStats();
                    renderPositions();
                }
            }
        }

        async function startBot() {
            if (isRunning || !userAddress) return;
            updateBotStatus(true);
            logEntry('Bot se zaganja...', 'system');
            try {
                connectionStatusEl.textContent = 'Povezujem z verigo...';
                connectionStatusEl.className = 'text-lg font-medium text-yellow-400';
                connection = new solanaWeb3.Connection(SOLANA_NODE_URL, 'confirmed');
                logEntry(`Povezan na Solana Mainnet`, 'system');
                connectionStatusEl.textContent = 'Povezan na verigo';
                connectionStatusEl.className = 'text-lg font-medium text-green-400';
                
                logsSubscriptionId = connection.onLogs(
                    new solanaWeb3.PublicKey(RAYDIUM_LIQUIDITY_PROGRAM_ID),
                    handleNewLog,
                    'confirmed'
                );

                priceSimInterval = setInterval(simulatePriceChangesAndSells, 5000);
            } catch(e) {
                console.error("Napaka pri zagonu bota:", e);
                logEntry(`Napaka pri povezovanju na verigo: ${e.message}`, 'error');
                connectionStatusEl.textContent = 'Napaka pri povezavi';
                connectionStatusEl.className = 'text-lg font-medium text-red-400';
                updateBotStatus(false);
            }
        }

        async function stopBot() {
            if (!isRunning) return;
            logEntry('Bot je bil ustavljen.', 'system');
            if (logsSubscriptionId && connection) {
                await connection.removeOnLogsListener(logsSubscriptionId);
            }
            clearInterval(priceSimInterval);
            connection = null;
            logsSubscriptionId = null;
            priceSimInterval = null;
            connectionStatusEl.textContent = 'Pripravljen';
            connectionStatusEl.className = 'text-lg font-medium text-gray-400';
            updateBotStatus(false);
        }

        function toggleBot() {
            if (isRunning) stopBot();
            else startBot();
        }

        // --- LOGIKA DENARNICE (PHANTOM) ---
        const getProvider = () => {
            // Modern standard: window.solana
            if ('solana' in window && window.solana?.isPhantom) {
                return window.solana;
            }
            // Older standard: window.phantom
            if ('phantom' in window && window.phantom?.solana?.isPhantom) {
                return window.phantom.solana;
            }
            return null;
        };

        async function connectWallet() {
            phantomProvider = getProvider();
            if (!phantomProvider) {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                if (/android|iphone|ipad|ipod/i.test(userAgent)) {
                     logEntry("Mobilne naprave zahtevajo uporabo brskalnika znotraj Phantom aplikacije.", 'error');
                } else {
                     logEntry("Phantom denarnica ni zaznana. Preverite, ali je name≈°ƒçena in aktivna. Vƒçasih brskalniki (npr. Brave) blokirajo denarnice. Poskusite z drugim brskalnikom ali osve≈æite stran.", 'error');
                     setTimeout(() => window.open("https://phantom.app/", "_blank"), 1000);
                }
                return;
            }
            try {
                const resp = await phantomProvider.connect({ onlyIfTrusted: true });
                userAddress = resp.publicKey.toString();
                await updateWalletInfo();
                setupWalletListeners();
            } catch (errOnSilent) {
                // If silent connection fails, try to connect by prompting the user
                 try {
                    const resp = await phantomProvider.connect();
                    userAddress = resp.publicKey.toString();
                    await updateWalletInfo();
                    setupWalletListeners();
                } catch (err) {
                    console.error("Napaka pri povezovanju denarnice:", err);
                    logEntry(`Povezava z denarnico neuspe≈°na: ${err.message}`, 'error');
                }
            }
        }

        async function updateWalletInfo() {
            if (!userAddress) return;
            const tempConnection = new solanaWeb3.Connection(SOLANA_NODE_URL.replace('wss', 'https'), 'confirmed');
            const balance = await tempConnection.getBalance(new solanaWeb3.PublicKey(userAddress));
            state.walletBalance = balance / solanaWeb3.LAMPORTS_PER_SOL;
            
            connectWalletBtn.textContent = `${userAddress.substring(0, 4)}...${userAddress.substring(userAddress.length - 4)}`;
            connectWalletBtn.className = 'bg-gray-700 text-gray-300 font-mono py-2 px-4 rounded-lg';
            
            toggleBtn.disabled = false;
            toggleBtn.textContent = 'üöÄ Za≈æeni Bota';
            toggleBtn.className = 'w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105';

            logEntry('Denarnica uspe≈°no povezana.', 'wallet', {address: userAddress});
            updateStats();
        }
        
        function setupWalletListeners() {
            if(phantomProvider) {
                phantomProvider.on('accountChanged', (publicKey) => {
                    if (publicKey) {
                        userAddress = publicKey.toString();
                        logEntry('Raƒçun v denarnici zamenjan.', 'wallet', {address: userAddress});
                        updateWalletInfo();
                    } else {
                        logEntry('Povezava z denarnico prekinjena.', 'error');
                        userAddress = null;
                        stopBot();
                        connectWalletBtn.textContent = 'Pove≈æi Denarnico';
                        connectWalletBtn.className = 'bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105';
                        toggleBtn.disabled = true;
                        toggleBtn.textContent = 'üöÄ Pove≈æi denarnico za zagon';
                        toggleBtn.className = 'w-full sm:w-auto bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-md btn-disabled';
                         updateStats();
                    }
                });
            }
        }

        // --- INICIALIZACIJA ---
        window.addEventListener('load', () => {
            toggleBtn.addEventListener('click', toggleBot);
            connectWalletBtn.addEventListener('click', connectWallet);
            walletBalanceEl.textContent = 'Pove≈æi denarnico';
            toggleBtn.classList.add('btn-disabled');
            updateStats();
            renderPositions();
        });

    </script>
</body>
</html>

