<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaulty AI - Financial Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #E5E7EB;
        }

        /* Animated Gradient Text */
        .animated-gradient-text {
            background: linear-gradient(90deg, #00fbff, #002afa, #ff00d4, #00fbff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            animation: gradient-flow 4s linear infinite;
        }

        @keyframes gradient-flow {
            to {
                background-position: -200% center;
            }
        }
        
        .gradient-border {
            border-width: 1px;
            border-style: solid;
            border-image: linear-gradient(90deg, rgba(0, 251, 255, 1) 0%, rgba(0, 42, 250, 1) 50%, rgba(255, 0, 212, 1) 100%) 1;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }

        .chat-message.thinking-animation::after {
            content: '...';
            display: inline-block;
            animation: thinking 1.5s infinite;
        }

        @keyframes thinking {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        /* Typing cursor effect */
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: #00fbff;
            animation: blink 1s step-end infinite;
            margin-left: 2px;
            vertical-align: bottom;
        }
        @keyframes blink {
            from, to { background-color: transparent }
            50% { background-color: #00fbff; }
        }

        /* Sidebar transition styles */
        @media (max-width: 1023px) {
            #app-container.sidebar-collapsed #sidebar {
                transform: translateX(-100%);
            }
        }
        @media (min-width: 1024px) {
            #app-container.sidebar-collapsed #sidebar {
                margin-left: -16rem; /* 16rem is w-64 */
            }
        }
        #app-container:not(.sidebar-collapsed) #menuBtn {
            display: none;
        }
    </style>
</head>

<body class="overflow-hidden">

    <div id="app-container" class="flex h-screen bg-black text-gray-200">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 p-4 flex flex-col transition-all duration-300 ease-in-out border-r border-gray-700 h-full z-20 flex-shrink-0 lg:relative absolute" style="background-color: #000000;">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-xl font-bold animated-gradient-text">Vaulty AI</h1>
                <button id="sidebarToggle" class="text-gray-500 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <button id="newChatBtn" class="w-full flex items-center justify-center gap-2 p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                New Chat
            </button>
            <div class="flex-grow overflow-y-auto">
                <h2 class="text-sm font-semibold text-gray-400 mb-2">Recent Chats</h2>
                <div id="recentChats" class="space-y-2">
                    <!-- Recent chats will be populated here -->
                </div>
            </div>
            <div class="mt-4">
                 <button id="openPremiumBtn" class="w-full flex items-center justify-center gap-2 p-2 rounded-lg bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                    <span>Premium</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative transition-all duration-300 ease-in-out">
             <header class="flex items-center justify-between p-2 sm:p-4 border-b border-gray-800" style="background-color: #000000;">
                <div class="flex items-center gap-4">
                    <button id="menuBtn" class="p-2 rounded-md hover:bg-gray-800">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                    <div class="relative" id="model-selector">
                        <button id="model-selector-btn" class="model-btn active flex items-center gap-2">
                            <span id="active-model-name">Vault 1 Basic</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="model-dropdown" class="absolute top-full mt-2 w-52 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-10 hidden">
                            <a href="#" class="model-dropdown-item" data-model="Vault 1 Basic">Vault 1 Basic</a>
                            <a href="#" class="model-dropdown-item" data-model="Vault 1 Advance">Vault 1 Advance</a>
                            <a href="#" class="model-dropdown-item" data-model="Vault 1 Pro" data-required-plan="Pro">
                                <span>Vault 1 Pro</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="lock-icon h-4 w-4 text-yellow-400 hidden" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v2H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V10a2 2 0 00-2-2h-1V6a4 4 0 00-4-4zm-2 6V6a2 2 0 114 0v2H8z" clip-rule="evenodd" />
                                </svg>
                            </a>
                            <a href="#" class="model-dropdown-item" data-model="Vault 1 Max" data-required-plan="Max">
                                <span>Vault 1 Max</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="lock-icon h-4 w-4 text-yellow-400 hidden" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v2H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V10a2 2 0 00-2-2h-1V6a4 4 0 00-4-4zm-2 6V6a2 2 0 114 0v2H8z" clip-rule="evenodd" />
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative group">
                        <button class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center hover:bg-gray-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </button>
                        <div class="absolute top-full right-0 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-10 hidden group-hover:block">
                            <div class="p-4">
                                <p class="text-sm text-gray-400">Available Credits</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xl font-bold animated-gradient-text" id="dropdownCreditDisplay">10.00</span>
                                    <span class="text-gray-400">VC</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                 <!-- Welcome Screen -->
                <div id="welcomeScreen" class="flex flex-col items-center justify-center h-full text-center">
                    <h1 class="text-5xl md:text-6xl font-bold animated-gradient-text">Vaulty AI</h1>
                    <p class="mt-4 text-xl text-gray-400">How can I help you today?</p>
                </div>
                <!-- Chat messages will appear here -->
            </div>

            <div class="p-4 md:p-6 bg-black/30">
                <div class="max-w-4xl mx-auto">
                    <form id="chatForm" class="flex items-center gap-2 md:gap-4 bg-gray-900/80 border border-gray-700 rounded-full p-2">
                        <label for="file-upload" class="cursor-pointer p-2 rounded-full hover:bg-gray-700 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                            </svg>
                        </label>
                         <input id="file-upload" type="file" class="hidden">
                        <input type="text" id="messageInput" placeholder="Ask anything about finance..." class="flex-1 bg-transparent focus:outline-none text-gray-200 placeholder-gray-500" autocomplete="off">
                        <button type="submit" id="sendBtn" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Premium Modal -->
    <div id="premiumModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-md flex items-center justify-center hidden z-50">
        <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 max-w-5xl w-full m-4 border border-gray-700 relative overflow-hidden">
             <button id="closePremiumBtn" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
             </button>
             <div class="text-center mb-8">
                 <h2 class="text-4xl font-bold animated-gradient-text">Unlock Full Potential</h2>
                 <p class="text-gray-400 mt-2">Choose the plan that best suits your needs.</p>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Free Plan -->
                <div class="plan-card">
                    <h3 class="text-2xl font-bold">Free</h3>
                    <p class="text-gray-400">Basic Features</p>
                    <p class="text-4xl font-bold my-4">$0</p>
                    <ul class="space-y-2 text-left">
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>$10 daily Vault Credits</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Standard speed</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Access to Vault 1 Basic</li>
                    </ul>
                    <button class="plan-selector-btn mt-6 w-full" data-plan="Free">Select Plan</button>
                </div>
                <!-- Pro Plan -->
                <div class="plan-card">
                    <h3 class="text-2xl font-bold">Pro</h3>
                    <p class="text-gray-400">For professionals</p>
                    <p class="text-4xl font-bold my-4">$14.99<span class="text-base font-normal text-gray-400">/mo</span></p>
                    <ul class="space-y-2 text-left">
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>$40 daily Vault Credits</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Increased speed</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Access to Vault 1 Pro</li>
                    </ul>
                     <button class="plan-selector-btn mt-6 w-full" data-plan="Pro">Upgrade</button>
                </div>
                <!-- Max Plan -->
                <div class="plan-card premium-gradient-border">
                    <div class="absolute top-0 right-0 -mt-3 mr-3 px-3 py-1 bg-gradient-to-r from-cyan-400 to-fuchsia-500 text-white text-sm font-bold rounded-full">Most Popular</div>
                    <h3 class="text-2xl font-bold">Max</h3>
                    <p class="text-gray-400">For heavy users</p>
                    <p class="text-4xl font-bold my-4">$99.99<span class="text-base font-normal text-gray-400">/mo</span></p>
                    <ul class="space-y-2 text-left">
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>$100 daily Vault Credits</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Highest speed</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Access to Vault 1 Max</li>
                    </ul>
                     <button class="plan-selector-btn mt-6 w-full plan-btn-premium" data-plan="Max">Upgrade</button>
                </div>
                <!-- Team Plan -->
                <div class="plan-card">
                    <h3 class="text-2xl font-bold">Team</h3>
                    <p class="text-gray-400">For companies & teams</p>
                    <p class="text-4xl font-bold my-4">$179.99<span class="text-base font-normal text-gray-400">/mo</span></p>
                    <ul class="space-y-2 text-left">
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Everything from Max</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Up to 5 users</li>
                        <li class="flex items-center gap-2"><svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Shared management</li>
                    </ul>
                     <button class="plan-selector-btn mt-6 w-full" data-plan="Team">Contact Us</button>
                </div>
             </div>
        </div>
    </div>
    
    <style>
        .model-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid #374151;
            background-color: transparent;
            color: #9CA3AF;
        }
        .model-btn:hover {
            background-color: #1F2937;
            color: #E5E7EB;
        }
        .model-btn.active {
            background: linear-gradient(90deg, rgba(0, 251, 255, 1) 0%, rgba(0, 42, 250, 1) 50%, rgba(255, 0, 212, 1) 100%);
            color: white;
            border-color: transparent;
        }
        .model-dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #D1D5DB;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        .model-dropdown-item:not(.locked):hover {
            background-color: #374151;
            color: #F9FAFB;
        }
        .model-dropdown-item.locked {
            color: #6B7280;
            cursor: pointer;
        }
         .model-dropdown-item.locked:hover {
            background-color: #374151;
         }
        @media (min-width: 640px) {
            .model-btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
        .plan-card {
            background-color: #111827;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #374151;
            position: relative;
        }
        .plan-selector-btn {
            background-color: #374151;
            color: #E5E7EB;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            width: 100%;
        }
        .plan-selector-btn:hover {
            background-color: #4B5563;
        }
        .plan-selector-btn.plan-btn-premium {
             background: linear-gradient(90deg, rgba(0, 251, 255, 1) 0%, rgba(0, 42, 250, 1) 50%, rgba(255, 0, 212, 1) 100%);
             color: white;
        }
        .plan-selector-btn.active-plan {
             background-color: transparent;
             border: 1px solid #4B5563;
             color: #9CA3AF;
             cursor: default;
        }
        .premium-gradient-border {
             border: 2px solid transparent;
             background-clip: padding-box;
             border-image: linear-gradient(90deg, rgba(0, 251, 255, 1) 0%, rgba(0, 42, 250, 1) 50%, rgba(255, 0, 212, 1) 100%) 1;
        }
    </style>

    <script type="module">
        const chatContainer = document.getElementById('chatContainer');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const dropdownCreditDisplay = document.getElementById('dropdownCreditDisplay');
        const recentChatsContainer = document.getElementById('recentChats');
        const newChatBtn = document.getElementById('newChatBtn');
        
        // Sidebar elements
        const appContainer = document.getElementById('app-container');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const sidebarToggle = document.getElementById('sidebarToggle');
        
        // Model Selector Elements
        const modelSelectorBtn = document.getElementById('model-selector-btn');
        const modelDropdown = document.getElementById('model-dropdown');
        const activeModelName = document.getElementById('active-model-name');
        const modelDropdownItems = document.querySelectorAll('.model-dropdown-item');

        // Premium Modal Elements
        const premiumModal = document.getElementById('premiumModal');
        const openPremiumBtn = document.getElementById('openPremiumBtn');
        const closePremiumBtn = document.getElementById('closePremiumBtn');
        const planSelectorBtns = document.querySelectorAll('.plan-selector-btn');

        let credits = 10.00;
        let activeModel = 'Vault 1 Basic';
        let chats = {};
        let currentChatId = null;
        let currentUserPlan = 'Free'; // Can be 'Free', 'Pro', 'Max', 'Team'

        // --- Event Listeners ---
        chatForm.addEventListener('submit', handleSendMessage);
        newChatBtn.addEventListener('click', createNewChat);

        // Sidebar Toggle Logic
        menuBtn.addEventListener('click', () => {
             appContainer.classList.remove('sidebar-collapsed');
        });
        sidebarToggle.addEventListener('click', () => {
             appContainer.classList.add('sidebar-collapsed');
        });

        openPremiumBtn.addEventListener('click', () => {
            updatePremiumModalUI();
            premiumModal.classList.remove('hidden');
        });
        closePremiumBtn.addEventListener('click', () => premiumModal.classList.add('hidden'));

        modelSelectorBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            updateModelLockStatus();
            modelDropdown.classList.toggle('hidden');
        });
        
        modelDropdown.addEventListener('click', (e) => {
            e.preventDefault();
            const targetItem = e.target.closest('.model-dropdown-item');
            if (!targetItem) return;

            if (targetItem.classList.contains('locked')) {
                updatePremiumModalUI();
                premiumModal.classList.remove('hidden');
                modelDropdown.classList.add('hidden');
                return;
            }

            activeModel = targetItem.dataset.model;
            activeModelName.textContent = activeModel;
            modelDropdown.classList.add('hidden');
        });


        document.addEventListener('click', (e) => {
            if (!document.getElementById('model-selector').contains(e.target)) {
                modelDropdown.classList.add('hidden');
            }
        });

        planSelectorBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentUserPlan = btn.dataset.plan;
                // In a real app, this would trigger a payment flow. Here we just update the state.
                console.log(`User plan changed to: ${currentUserPlan}`);
                
                // If user selects a lower plan, downgrade active model if necessary
                const planHierarchy = { 'Free': 0, 'Pro': 1, 'Max': 2, 'Team': 2 };
                const modelHierarchy = { 'Vault 1 Basic': 0, 'Vault 1 Advance': 0, 'Vault 1 Pro': 1, 'Vault 1 Max': 2 };

                if (modelHierarchy[activeModel] > planHierarchy[currentUserPlan]) {
                    activeModel = 'Vault 1 Basic';
                    activeModelName.textContent = activeModel;
                }

                premiumModal.classList.add('hidden');
            });
        });


        // --- Core Functions ---

        async function handleSendMessage(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            if (!currentChatId) {
                createNewChat();
            }

            welcomeScreen.classList.add('hidden');
            
            appendMessage('user', message);
            chats[currentChatId].messages.push({ role: 'user', content: message });
            saveChats();

            messageInput.value = '';
            messageInput.disabled = true;
            sendBtn.disabled = true;

            await getBotResponse(message);
        }
        
        async function getBotResponse(userMessage) {
            const thinkingMessageId = `msg-${Date.now()}`;
            
            appendThinkingMessage(thinkingMessageId);

            // This timeout is just for the initial "Thinking" message to appear smoothly
            await new Promise(resolve => setTimeout(resolve, 500));

            const botMessageElement = document.getElementById(thinkingMessageId);
            const thinkingContent = botMessageElement.querySelector('.thinking-content');
            const thinkingDropdown = botMessageElement.querySelector('.thinking-dropdown');
            
            thinkingContent.innerHTML = 'Generating response... <span class="typing-cursor"></span>';

            const thoughts = [
                'Analyzing query...',
                'Formatting request for the Gemini API...',
                `Querying with the ${activeModel} model...`,
                'Awaiting response from the language model...'
            ];
            
            let thoughtIndex = 0;
            const thoughtInterval = setInterval(() => {
                if (thoughtIndex < thoughts.length) {
                    const p = document.createElement('p');
                    p.textContent = `[Step ${thoughtIndex + 1}] ${thoughts[thoughtIndex]}`;
                    thinkingDropdown.appendChild(p);
                    thoughtIndex++;
                } else {
                    clearInterval(thoughtInterval);
                }
            }, 1000);

            const responseText = await callGeminiAPI(userMessage);
            clearInterval(thoughtInterval);

            const cost = calculateCost(responseText);
            updateCredits(credits - cost);

            const messageContent = botMessageElement.querySelector('.chat-message-content');
            typeMessage(messageContent, responseText);

            const actions = botMessageElement.querySelector('.chat-actions');
            actions.classList.remove('hidden');

            chats[currentChatId].messages.push({ role: 'bot', content: responseText });
            saveChats();
            
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }
        
        async function callGeminiAPI(userQuery) {
            const systemPrompt = "You are Vaulty AI, a world-class financial analyst and cryptocurrency expert. Your goal is to provide concise, accurate, and insightful information about finance, stocks, crypto, and business. Do not answer questions outside of these topics. If asked about an unrelated topic, politely state that you only answer finance-related questions.";
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error("API Error:", error);
                    return "Sorry, I encountered an error while processing your request. Please try again later.";
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    return "Sorry, I couldn't generate a response. The model's response was empty.";
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                return "Sorry, I'm having trouble connecting to my services. Please check your internet connection.";
            }
        }


        function appendMessage(role, content) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start gap-3 ${role === 'user' ? 'justify-end' : ''}`;
            
            const contentHTML = `
                <div class="chat-avatar">${role === 'user' ? 'U' : 'V'}</div>
                <div class="chat-bubble ${role === 'user' ? 'bg-gray-800' : 'bg-gray-700'}">
                    <p>${content}</p>
                </div>
            `;
            
            messageWrapper.innerHTML = contentHTML;
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function appendThinkingMessage(id) {
            const messageWrapper = document.createElement('div');
            messageWrapper.id = id;
            messageWrapper.className = 'flex items-start gap-3';

            const contentHTML = `
                <div class="chat-avatar gradient-bg">V</div>
                <div class="bot-message-container">
                    <div class="flex items-center justify-between cursor-pointer" onclick="document.getElementById('dd-${id}').classList.toggle('hidden')">
                         <p class="chat-message-content thinking-content">Thinking<span class="thinking-animation"></span></p>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                         </svg>
                    </div>
                    <div id="dd-${id}" class="thinking-dropdown hidden mt-2 pt-2 border-t border-gray-600 text-xs text-gray-400 space-y-1">
                        <!-- Thinking process details here -->
                    </div>
                    <div class="chat-actions hidden mt-2 pt-2 border-t border-gray-600 flex items-center gap-4 text-gray-400">
                        <!-- Action buttons will be added here -->
                    </div>
                </div>
            `;
            messageWrapper.innerHTML = contentHTML;
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function typeMessage(element, text) {
            element.innerHTML = '';
            let i = 0;
            const interval = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(interval);
                    addActionsToMessage(element.closest('.bot-message-container'));
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 30);
        }

        function addActionsToMessage(bubbleElement) {
            if (!bubbleElement) return;
            const actionsContainer = bubbleElement.querySelector('.chat-actions');
            const content = bubbleElement.querySelector('.chat-message-content').textContent;

            actionsContainer.innerHTML = `
                <button title="Copy"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button>
                <button title="Text-to-Speech"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg></button>
                <button title="Like"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" /></svg></button>
                <button title="Dislike"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M18 9.5a1.5 1.5 0 11-3 0v-6a1.5 1.5 0 013 0v6zM14 9.667v-5.43a2 2 0 00-1.106-1.79l-.05-.025A4 4 0 0011.057 2H5.642a2 2 0 00-1.962 1.608l-1.2 6A2 2 0 004.44 12H8v4a2 2 0 002 2 1 1 0 001-1v-.667a4 4 0 01.8-2.4l1.2-2.4a4 4 0 00.8-2.4z" /></svg></button>
            `;
            actionsContainer.querySelector('button:nth-child(1)').onclick = () => copyToClipboard(content);
            actionsContainer.querySelector('button:nth-child(2)').onclick = () => speakText(content);
        }

        // --- Utility Functions ---
        
        function createNewChat() {
            const newId = `chat-${Date.now()}`;
            currentChatId = newId;
            chats[newId] = { id: newId, title: 'New Chat', messages: [] };
            chatContainer.innerHTML = '';
            welcomeScreen.classList.remove('hidden');
            updateRecentChats();
            setActiveChat(newId);
            saveChats();
        }

        function loadChat(chatId) {
            if (!chats[chatId]) return;
            currentChatId = chatId;
            const chat = chats[chatId];
            chatContainer.innerHTML = '';
            
            if (chat.messages.length === 0) {
                 welcomeScreen.classList.remove('hidden');
            } else {
                 welcomeScreen.classList.add('hidden');
                 chat.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        appendMessage(msg.role, msg.content);
                    } else {
                        // For past bot messages, display them instantly
                        appendInstantBotMessage(msg.content);
                    }
                 });
            }
            setActiveChat(chatId);
        }
        
         function appendInstantBotMessage(content) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex items-start gap-3';
            
            const contentHTML = `
                <div class="chat-avatar gradient-bg">V</div>
                <div class="bot-message-container">
                    <p class="chat-message-content">${content}</p>
                     <div class="chat-actions mt-2 pt-2 border-t border-gray-600 flex items-center gap-4 text-gray-400">
                     </div>
                </div>
            `;
            messageWrapper.innerHTML = contentHTML;
            chatContainer.appendChild(messageWrapper);
            addActionsToMessage(messageWrapper.querySelector('.bot-message-container'));
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateRecentChats() {
            recentChatsContainer.innerHTML = '';
            Object.values(chats).reverse().forEach(chat => {
                const chatLink = document.createElement('div');
                chatLink.className = 'recent-chat-link';
                chatLink.dataset.id = chat.id;
                chatLink.textContent = chat.messages.length > 0 ? chat.messages[0].content.substring(0, 25) + '...' : chat.title;
                if (chat.id === currentChatId) {
                    chatLink.classList.add('active');
                }
                chatLink.onclick = () => loadChat(chat.id);
                recentChatsContainer.appendChild(chatLink);
            });
        }
        
        function setActiveChat(chatId) {
            document.querySelectorAll('.recent-chat-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.id === chatId) {
                    link.classList.add('active');
                }
            });
        }

        function calculateCost(responseText) {
            const length = responseText.length;
            if (length < 200) { // Short answer
                return parseFloat((Math.random() * (0.20 - 0.10) + 0.10).toFixed(2));
            } else { // Long answer
                return parseFloat((Math.random() * (0.40 - 0.21) + 0.21).toFixed(2));
            }
        }

        function updateCredits(newBalance) {
            credits = Math.max(0, newBalance);
            dropdownCreditDisplay.textContent = credits.toFixed(2);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Optional: Show a notification
            });
        }

        function speakText(text) {
             if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Your browser does not support text-to-speech.');
            }
        }

        function updateModelLockStatus() {
            const planHierarchy = { 'Free': 0, 'Pro': 1, 'Max': 2, 'Team': 2 };
            const userLevel = planHierarchy[currentUserPlan];

            modelDropdownItems.forEach(item => {
                const requiredPlan = item.dataset.requiredPlan;
                if (!requiredPlan) return;

                const requiredLevel = planHierarchy[requiredPlan];
                const lockIcon = item.querySelector('.lock-icon');

                if (requiredLevel > userLevel) {
                    item.classList.add('locked');
                    if(lockIcon) lockIcon.classList.remove('hidden');
                } else {
                    item.classList.remove('locked');
                    if(lockIcon) lockIcon.classList.add('hidden');
                }
            });
        }

        function updatePremiumModalUI() {
            planSelectorBtns.forEach(btn => {
                btn.classList.remove('active-plan');
                btn.textContent = btn.dataset.plan === "Team" ? "Contact Us" : "Upgrade";
                if (btn.dataset.plan === currentUserPlan) {
                    btn.classList.add('active-plan');
                    btn.textContent = 'Current Plan';
                }
            });
        }

        // --- Local Storage Persistence ---
        function saveChats() {
            localStorage.setItem('vaultyChats', JSON.stringify(chats));
            updateRecentChats();
        }

        function loadChatsFromStorage() {
            const storedChats = localStorage.getItem('vaultyChats');
            if (storedChats) {
                chats = JSON.parse(storedChats);
                const chatIds = Object.keys(chats);
                if (chatIds.length > 0) {
                    currentChatId = chatIds[chatIds.length - 1]; // Load last active chat
                    loadChat(currentChatId);
                }
            }
            updateRecentChats();
        }

        // --- Initial Load ---
        function initializeUI() {
            loadChatsFromStorage();
            if(!currentChatId) {
                 welcomeScreen.classList.remove('hidden');
            } else {
                welcomeScreen.classList.add('hidden');
            }

            // Set initial sidebar state based on screen size
            if (window.innerWidth < 1024) {
                appContainer.classList.add('sidebar-collapsed');
            }
        }
        
        initializeUI();
        
    </script>
    <style>
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }
        .flex.items-start .chat-avatar {
            background-color: #374151;
        }
        .flex.justify-end .chat-avatar {
            background-color: #1F2937;
        }
        .gradient-bg {
            background: linear-gradient(90deg, rgba(0, 251, 255, 1) 0%, rgba(0, 42, 250, 1) 50%, rgba(255, 0, 212, 1) 100%);
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            line-height: 1.6;
        }
        .flex.items-start .chat-bubble {
            border-top-left-radius: 0.5rem;
        }
        .flex.justify-end .chat-bubble {
            border-top-right-radius: 0.5rem;
        }
        .recent-chat-link {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #D1D5DB;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .recent-chat-link:hover {
            background-color: #374151;
        }
        .recent-chat-link.active {
            background-color: #4B5563;
            color: #F9FAFB;
            font-weight: 500;
        }
        .chat-actions button {
            transition: color 0.2s;
        }
        .chat-actions button:hover {
            color: #F9FAFB;
        }
        .bot-message-container {
            max-width: 60%;
            line-height: 1.6;
        }
    </style>
</body>

</html>


